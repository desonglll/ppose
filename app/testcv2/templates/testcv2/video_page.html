{% extends "testcv2/base.html" %}
{% block body %}
    <h1>Video Stream</h1>
    <div class="container">
        <div class="d-flex justify-content-around">
            <form action="{% url 'video_page' %}" method="get">
                <button class="btn btn-primary" type="submit" name="param" value="1">显示骨架图</button>
                <button class="btn btn-primary" type="submit" name="param" value="2">显示关键点</button>
                <button class="btn btn-primary" type="submit" name="param" value="3">显示胳膊夹角</button>
                <button class="btn btn-primary" type="submit" name="param" value="4">显示抬头角度（使用单眼）</button>
                <button class="btn btn-primary" type="submit" name="param" value="5">显示抬头角度（使用双眼）</button>
                <button class="btn btn-primary" type="submit" name="param" value="6">显示抬头角度（使用所有头部信息）
                </button>
            </form>
        </div>
        <div>
            <img id="video_stream" alt="Video Stream" width="100%" src="">
            <div id="angle_display"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function startStream() {
            const imgElement = document.getElementById('video_stream');
            const angleElement = document.getElementById('angle_display');
            const param = new URLSearchParams(window.location.search).get('param') || '1';

            const eventSource = new EventSource(`/test/video-feed?param=${param}`);

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    imgElement.src = 'data:image/jpeg;base64,' + data.image;
                    angleElement.textContent = `角度: ${data.angle}`;
                } catch (e) {
                    console.error(e);
                }
            };

            eventSource.onerror = function () {
                console.error('Error receiving video stream');
                eventSource.close();  // 关闭流
            };
        }

        document.addEventListener('DOMContentLoaded', startStream);
    </script>
{% endblock %}
