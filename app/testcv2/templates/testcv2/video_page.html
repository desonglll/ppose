{% extends "testcv2/base.html" %}
{% load static %}

{% block video-container %}
    <h1>Video Stream</h1>
    <div class="video_window">
        <!-- 表单提交时传递param参数 -->
        <form action="{% url 'video_page' %}" method="get">
            <button type="submit" name="param" value="1">显示骨架图</button>
            <button type="submit" name="param" value="2">显示关键点</button>
            <button type="submit" name="param" value="3">显示胳膊夹角</button>
            <button type="submit" name="param" value="4">显示抬头角度（使用单眼）</button>
            <button type="submit" name="param" value="5">显示抬头角度（使用双眼）</button>
            <button type="submit" name="param" value="6">显示抬头角度（使用所有头部信息）</button>
        </form>


        <img id="video_stream" alt="Video Stream" width="800">
        <div id="angle_display"></div>

    </div>
    <div>this is a test</div>
{% endblock %}

{% block scripts %}
   <script>
    function startStream() {
        const imgElement = document.getElementById('video_stream');
        const angleElement = document.getElementById('angle_display');

        const url = imgElement.src;
        const eventSource = new EventSource(url);

        fetch(url).then(response => {
            const reader = response.body.getReader();
            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) return;
                    const text = new TextDecoder('utf-8').decode(value);
                    try {
                        const frame = JSON.parse(text.replace(/--frame\r\nContent-Type: application\/json\r\n\r\n/g, ''));
                        imgElement.src = 'data:image/jpeg;base64,' + btoa(frame.image);
                        angleElement.textContent = `角度: ${frame.angle}`;
                    } catch (e) {
                        console.error(e);
                    }
                    read();
                });
            }
            read();
        });
    }
</script>

<img id="video_stream" alt="Video Stream" width="800">
<div id="angle_display"></div>

{% endblock %}